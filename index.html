<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de Caneta BIC - 3D Match</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background: #222; }
        
        /* O vídeo da câmera ocupa a tela toda */
        #webcam {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
            transform: scaleX(-1); /* Espelhar câmera */
        }

        /* O modelo 3D fica no canto como referência */
        #canvas-3d {
            position: absolute;
            top: 20px; right: 20px;
            width: 150px; height: 150px;
            z-index: 2;
            border: 3px solid #00AAFF;
            border-radius: 10px;
            background: rgba(0,0,0,0.5);
        }

        /* Interface de Controle */
        #ui-layer {
            position: absolute;
            bottom: 30px; left: 0;
            width: 100%;
            z-index: 3;
            text-align: center;
            color: white;
        }

        .status-box {
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.6);
            display: inline-block;
            border-radius: 8px;
        }

        .match { color: #00FF00; border: 2px solid #00FF00; }
        .no-match { color: #FF0000; border: 2px solid #FF0000; }
        .neutral { color: #FFFF00; }

        .btn-container {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        button {
            padding: 15px 25px;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }

        button:active { transform: scale(0.95); }
        .btn-negative { background-color: #ff4d4d; color: white; }
        .btn-positive { background-color: #4dff88; color: #004400; }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; z-index: 10; font-size: 20px; background: rgba(0,0,0,0.8);
            padding: 20px; border-radius: 10px;
        }
    </style>
</head>
<body>

    <div id="loading">Carregando IA e Modelo 3D...</div>

    <video id="webcam" autoplay playsinline muted></video>

    <div id="canvas-3d"></div>

    <div id="ui-layer">
        <div id="status" class="status-box neutral">Aguardando Treinamento...</div>
        
        <p style="font-size: 12px; margin-bottom: 5px;">Segure o botão para ensinar a IA:</p>
        <div class="btn-container">
            <button class="btn-negative" onmousedown="startTraining('nada')" onmouseup="stopTraining()" ontouchstart="startTraining('nada')" ontouchend="stopTraining()">
                1. Aprender "Outra Coisa"
            </button>
            <button class="btn-positive" onmousedown="startTraining('caneta')" onmouseup="stopTraining()" ontouchstart="startTraining('caneta')" ontouchend="stopTraining()">
                2. Aprender "Esta Caneta"
            </button>
        </div>
    </div>

    <script>
        let net;
        let classifier;
        let webcamElement;
        let isTraining = false;
        let trainingLabel = null;
        let timer;

        // --- CONFIGURAÇÃO 3D (THREE.JS) ---
        function init3D() {
            const container = document.getElementById('canvas-3d');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true }); // Fundo transparente
            
            renderer.setSize(150, 150);
            container.appendChild(renderer.domElement);

            // Luzes
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);

            // Carregar o modelo GLB
            const loader = new THREE.GLTFLoader();
            loader.load('Sketchfab_Scene (1).glb', function (gltf) {
                const model = gltf.scene;
                // Ajustar escala e posição manual para caber na janelinha
                model.scale.set(100, 100, 100); 
                model.position.y = -2;
                scene.add(model);

                // Animação simples (rotação)
                function animate() {
                    requestAnimationFrame(animate);
                    model.rotation.y += 0.01;
                    model.rotation.x = 0.5; // Leve inclinação para ver melhor
                    renderer.render(scene, camera);
                }
                animate();
            }, undefined, function (error) {
                console.error('Erro ao carregar 3D:', error);
                container.innerHTML = "<p style='color:white; font-size:10px; text-align:center;'>Modelo 3D não encontrado<br>Verifique o nome do arquivo.</p>";
            });

            camera.position.z = 10;
        }

        // --- CONFIGURAÇÃO IA (TENSORFLOW.JS) ---
        async function setupWebcam() {
            webcamElement = document.getElementById('webcam');
            return new Promise((resolve, reject) => {
                const navigatorAny = navigator;
                navigator.getUserMedia = navigator.getUserMedia ||
                    navigatorAny.webkitGetUserMedia || navigatorAny.mozGetUserMedia ||
                    navigatorAny.msGetUserMedia;
                
                if (navigator.getUserMedia) {
                    navigator.getUserMedia({ video: true },
                        stream => {
                            webcamElement.srcObject = stream;
                            webcamElement.addEventListener('loadeddata', () => resolve(), false);
                        },
                        error => reject());
                } else {
                    reject();
                }
            });
        }

        async function initApp() {
            console.log('Carregando MobileNet...');
            
            // 1. Inicializa o 3D
            init3D();

            // 2. Carrega o Modelo Base (MobileNet)
            net = await mobilenet.load();
            
            // 3. Cria o Classificador KNN
            classifier = knnClassifier.create();

            // 4. Inicia Webcam
            await setupWebcam();

            document.getElementById('loading').style.display = 'none';
            
            // Loop principal
            while (true) {
                if (classifier.getNumClasses() > 0) {
                    const activation = net.infer(webcamElement, 'conv_preds');
                    const result = await classifier.predictClass(activation);

                    const statusDiv = document.getElementById('status');
                    
                    // Lógica de Confiança e Match
                    // label 'caneta' = Match
                    // label 'nada' = Não reconhecido
                    if (result.label === 'caneta' && result.confidences['caneta'] > 0.8) {
                        statusDiv.innerText = "MATCH (Caneta BIC)";
                        statusDiv.className = "status-box match";
                    } else {
                        statusDiv.innerText = "Objeto não reconhecido";
                        statusDiv.className = "status-box no-match";
                    }
                }
                
                // Treinamento em tempo real
                if (isTraining && trainingLabel) {
                    addExample(trainingLabel);
                }

                await tf.nextFrame();
            }
        }

        // Função para adicionar exemplos ao classificador
        const addExample = classId => {
            const activation = net.infer(webcamElement, 'conv_preds');
            classifier.addExample(activation, classId);
        };

        // Controles dos botões
        window.startTraining = (label) => {
            isTraining = true;
            trainingLabel = label;
            console.log(`Treinando: ${label}`);
        };

        window.stopTraining = () => {
            isTraining = false;
            trainingLabel = null;
        };

        // Iniciar tudo
        initApp();

    </script>
</body>
</html>